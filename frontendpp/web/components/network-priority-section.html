<!-- Network Priority Configuration Section -->
<div class="space-y-6">
    <!-- Page Header with Connection Status -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-2xl text-neutral-900 mb-2 flex items-center">
                    <i class="fa-solid fa-route text-neutral-700 mr-3"></i>
                    Network Interface Routing Priority
                </h2>
                <p class="text-neutral-600">Configure interface priorities and routing rules for internet access</p>
            </div>
            <div class="flex items-center space-x-4">
                <button id="refresh-priority-btn" class="text-sm text-neutral-500 hover:text-neutral-700 flex items-center space-x-1 px-3 py-1 rounded border border-neutral-300 hover:bg-neutral-50 transition-colors" title="Refresh network priority data">
                    <i class="fa-solid fa-refresh" id="priority-refresh-icon"></i>
                    <span>Refresh</span>
                </button>
                <div id="priority-connection-status" class="flex items-center space-x-1 text-xs text-neutral-400">
                    <div class="w-2 h-2 bg-red-500 rounded-full" id="priority-status-dot"></div>
                    <span id="priority-connection-text">Disconnected</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Interface Priority Order Section -->
    <div id="priority-section" class="bg-white rounded-lg border border-neutral-200 p-6 mb-6">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg text-neutral-800 flex items-center">
                <i class="fa-solid fa-layer-group mr-2 text-neutral-600"></i>
                Interface Priority Order
            </h3>
        </div>

        <div class="bg-neutral-50 rounded-lg p-4 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="text-center">
                    <div class="text-2xl text-neutral-800" data-stat="total">0</div>
                    <div class="text-sm text-neutral-600">Total Interfaces</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl text-green-600" data-stat="online">0</div>
                    <div class="text-sm text-neutral-600">Online</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl text-red-600" data-stat="offline">0</div>
                    <div class="text-sm text-neutral-600">Offline</div>
                </div>
            </div>
        </div>

        <div id="interfaces-container" class="space-y-3">
            <!-- Interfaces will be dynamically populated here -->
        </div>
    </div>

    <!-- Custom Routing Rules Section -->
    <div id="routing-rules-section" class="bg-white rounded-lg border border-neutral-200 p-6 mb-6">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg text-neutral-800 flex items-center">
                <i class="fa-solid fa-list-ul mr-2 text-neutral-600"></i>
                Custom Routing Rules
            </h3>
            <div class="flex space-x-2">
                <button id="add-rule-btn" class="bg-neutral-600 hover:bg-neutral-700 text-white px-4 py-2 rounded-md flex items-center text-sm">
                    <i class="fa-solid fa-plus mr-2"></i>
                    Add Rule
                </button>
                <button id="export-rules-btn" class="bg-neutral-600 hover:bg-neutral-700 text-white px-4 py-2 rounded-md flex items-center text-sm">
                    <i class="fa-solid fa-download mr-2"></i>
                    Export Rules
                </button>
            </div>
        </div>

        <div class="bg-white border border-neutral-200 rounded-lg overflow-hidden">
            <table class="w-full">
                <thead class="bg-neutral-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs text-neutral-500 uppercase tracking-wider">
                            <input type="checkbox" class="rounded border-neutral-300" id="select-all-rules">
                        </th>
                        <th class="px-4 py-3 text-left text-xs text-neutral-500 uppercase tracking-wider">Priority</th>
                        <th class="px-4 py-3 text-left text-xs text-neutral-500 uppercase tracking-wider">Destination</th>
                        <th class="px-4 py-3 text-left text-xs text-neutral-500 uppercase tracking-wider">Gateway</th>
                        <th class="px-4 py-3 text-left text-xs text-neutral-500 uppercase tracking-wider">Interface</th>
                        <th class="px-4 py-3 text-left text-xs text-neutral-500 uppercase tracking-wider">Metric</th>
                        <th class="px-4 py-3 text-left text-xs text-neutral-500 uppercase tracking-wider">Status</th>
                        <th class="px-4 py-3 text-left text-xs text-neutral-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="routing-rules-tbody" class="divide-y divide-neutral-200">
                    <!-- Routing rules will be dynamically populated here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex items-center justify-between bg-white rounded-lg border border-neutral-200 p-4">
        <div class="flex items-center space-x-4">
            <button id="reset-defaults-btn" class="text-neutral-600 hover:text-neutral-800 text-sm flex items-center">
                <i class="fa-solid fa-undo mr-2"></i>
                Reset to Default
            </button>
            <button id="preview-changes-btn" class="text-neutral-600 hover:text-neutral-800 text-sm flex items-center">
                <i class="fa-solid fa-eye mr-2"></i>
                Preview Changes
            </button>
        </div>
        <div class="flex items-center space-x-3">
            <button id="cancel-btn" class="px-4 py-2 text-neutral-700 border border-neutral-300 rounded-md hover:bg-neutral-50">
                Cancel
            </button>
            <button id="apply-changes-btn" class="px-4 py-2 bg-neutral-600 text-white rounded-md hover:bg-neutral-700">
                Apply Changes
            </button>
        </div>
    </div>
</div>

<!-- Add Routing Rule Popup -->
<div id="add-rule-popup" class="popup-overlay" style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;">
    <div class="popup-content" style="background: white; border-radius: 12px; padding: 0; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; transform: scale(0.9); transition: transform 0.3s ease; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
        <div class="bg-white w-full h-auto shadow-lg overflow-y-auto">
            <!-- Header -->
            <div class="border-b border-neutral-200 p-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i class="fa-solid fa-route text-blue-600 text-lg"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl text-neutral-900">Add New Routing Rule</h1>
                            <p class="text-neutral-500 text-sm">Configure custom routing rule for network traffic</p>
                        </div>
                    </div>
                    <button class="add-rule-popup-close w-8 h-8 rounded-full bg-neutral-100 hover:bg-neutral-200 flex items-center justify-center">
                        <i class="fa-solid fa-xmark text-neutral-500"></i>
                    </button>
                </div>
            </div>
            <!-- Content -->
            <div class="p-6">
                <form id="add-rule-form" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-neutral-700 mb-2">Destination Network *</label>
                            <input type="text" id="rule-destination" name="destination" required
                                   class="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="e.g., 192.168.1.0/24">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-neutral-700 mb-2">Gateway *</label>
                            <input type="text" id="rule-gateway" name="gateway" required
                                   class="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="e.g., 192.168.1.1">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-neutral-700 mb-2">Interface *</label>
                            <select id="rule-interface" name="interface" required
                                    class="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Select an interface...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-neutral-700 mb-2">Metric *</label>
                            <input type="number" id="rule-metric" name="metric" required min="1" max="9999"
                                   class="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="e.g., 100">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-neutral-700 mb-2">Priority *</label>
                            <input type="number" id="rule-priority" name="priority" required min="1" max="100"
                                   class="w-full px-3 py-2 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="e.g., 1">
                        </div>
                    </div>
                </form>
            </div>
            <!-- Footer -->
            <div class="border-t border-neutral-200 p-6 flex justify-end space-x-3">
                <button type="button" class="add-rule-popup-cancel px-4 py-2 bg-neutral-100 text-neutral-700 rounded-lg hover:bg-neutral-200">
                    Cancel
                </button>
                <button type="button" class="add-rule-popup-save px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Add Rule
                </button>
            </div>
        </div>
    </div>
</div>

<script>
/**
 * Network Priority WebSocket Client
 * Handles WebSocket communication for network priority operations
 */

class NetworkPriorityWebSocket {
    constructor() {
        this.ws = null;
        this.connected = false;
        this.reconnectAttempts = 0;
        this.maxReconnectAttempts = 10;
        this.reconnectDelay = 5000;
        
        // Dynamic host detection for WebSocket URL
        const currentHost = window.location.hostname;
        this.url = `ws://${currentHost}:9002`; // Backend-datalink WebSocket server
        
        // Event callbacks
        this.onConnected = null;
        this.onDisconnected = null;
        this.onError = null;
        this.onNetworkPriorityData = null;
        this.onNetworkPriorityResponse = null;
    }

    connect() {
        try {
            console.log('[NETWORK-PRIORITY-WS] Connecting to:', this.url);
            this.ws = new WebSocket(this.url);
            
            this.ws.onopen = () => {
                console.log('[NETWORK-PRIORITY-WS] Connected to backend-datalink server');
                this.connected = true;
                this.reconnectAttempts = 0;
                
                if (this.onConnected) {
                    this.onConnected();
                }
            };

            this.ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    this.handleMessage(message);
                } catch (error) {
                    console.error('[NETWORK-PRIORITY-WS] Failed to parse message:', error);
                }
            };

            this.ws.onclose = () => {
                console.log('[NETWORK-PRIORITY-WS] Disconnected from server');
                this.connected = false;
                
                if (this.onDisconnected) {
                    this.onDisconnected();
                }
                
                this.attemptReconnect();
            };

            this.ws.onerror = (error) => {
                console.error('[NETWORK-PRIORITY-WS] WebSocket error:', error);
                this.connected = false;
                
                let errorMessage = 'WebSocket connection error';
                if (error instanceof Error) {
                    errorMessage += ': ' + error.message;
                }
                
                if (this.onError) {
                    this.onError(new Error(errorMessage));
                }
            };

        } catch (error) {
            console.error('[NETWORK-PRIORITY-WS] Failed to create WebSocket connection:', error);
            if (this.onError) {
                this.onError(error);
            }
        }
    }

    disconnect() {
        if (this.ws) {
            this.reconnectAttempts = this.maxReconnectAttempts; // Prevent reconnection
            this.ws.close();
            this.ws = null;
        }
        
        this.connected = false;
    }

    sendMessage(message) {
        if (this.connected && this.ws.readyState === WebSocket.OPEN) {
            this.ws.send(JSON.stringify(message));
            console.log('[NETWORK-PRIORITY-WS] Sent message:', message);
        } else {
            console.error('[NETWORK-PRIORITY-WS] Cannot send message - WebSocket not connected');
        }
    }

    handleMessage(message) {
        
        switch (message.type) {
            case 'network_priority_data':
                if (this.onNetworkPriorityData) {
                    this.onNetworkPriorityData(message.data);
                }
                break;
                
            case 'network_priority_response':
                if (this.onNetworkPriorityResponse) {
                    this.onNetworkPriorityResponse(message.data);
                }
                break;
                
            default:
                break;
        }
    }

    // Network priority specific methods
    requestNetworkPriorityData() {
        this.sendMessage({
            type: 'request_network_priority_data',
            timestamp: new Date().toISOString()
        });
    }

    setInterfacePriority(interfaceName, priority) {
        this.sendMessage({
            type: 'set_interface_priority',
            data: {
                interface: interfaceName,
                priority: priority
            },
            timestamp: new Date().toISOString()
        });
    }

    addRoutingRule(rule) {
        this.sendMessage({
            type: 'add_routing_rule',
            data: rule,
            timestamp: new Date().toISOString()
        });
    }

    updateRoutingRule(ruleId, rule) {
        this.sendMessage({
            type: 'update_routing_rule',
            data: {
                id: ruleId,
                ...rule
            },
            timestamp: new Date().toISOString()
        });
    }

    deleteRoutingRule(ruleId) {
        this.sendMessage({
            type: 'delete_routing_rule',
            data: {
                id: ruleId
            },
            timestamp: new Date().toISOString()
        });
    }

    applyConfiguration() {
        this.sendMessage({
            type: 'apply_configuration',
            timestamp: new Date().toISOString()
        });
    }

    resetToDefaults() {
        this.sendMessage({
            type: 'reset_to_defaults',
            timestamp: new Date().toISOString()
        });
    }

    attemptReconnect() {
        if (this.reconnectAttempts >= this.maxReconnectAttempts) {
            console.error('[NETWORK-PRIORITY-WS] Max reconnect attempts reached');
            
            if (this.onError) {
                this.onError(new Error('Failed to reconnect to WebSocket server'));
            }
            return;
        }
        
        this.reconnectAttempts++;
        console.log(`[NETWORK-PRIORITY-WS] Reconnection attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts}`);
        
        setTimeout(() => {
            this.connect();
        }, this.reconnectDelay);
    }
}

/**
 * Network Priority Section
 * Manages network priority settings and routing rules
 */
class NetworkPrioritySection {
    constructor() {
        this.state = {
            data: {
                networkInterfaces: [],
                routingRules: [],
                statistics: { total: 0, online: 0, offline: 0 },
                lastUpdated: null
            },
            ui: {
                selectedRules: new Set(),
                isLoading: false,
                lastError: null
            }
        };
        this.popupOpen = false;
        this.currentPopup = null;
        this.initialized = false;
        
        // Initialize WebSocket client
        this.wsClient = new NetworkPriorityWebSocket();
        this.setupWebSocketCallbacks();
        
        this.init();
    }

    init() {
        console.log('[NETWORK-PRIORITY] Initializing Network Priority Section...');
        
        // Prevent duplicate initialization
        if (this.initialized) {
            console.log('[NETWORK-PRIORITY] Already initialized, skipping...');
            return;
        }
        
        // Add debugging to check if elements exist
        console.log('[NETWORK-PRIORITY] Checking if buttons exist...');
        console.log('[NETWORK-PRIORITY] add-rule-btn:', document.getElementById('add-rule-btn'));
        console.log('[NETWORK-PRIORITY] export-rules-btn:', document.getElementById('export-rules-btn'));
        console.log('[NETWORK-PRIORITY] reset-defaults-btn:', document.getElementById('reset-defaults-btn'));
        console.log('[NETWORK-PRIORITY] preview-changes-btn:', document.getElementById('preview-changes-btn'));
        console.log('[NETWORK-PRIORITY] apply-changes-btn:', document.getElementById('apply-changes-btn'));
        
        this.setupEventHandlers();
        this.setupGlobalHandlers();
        
        // Initialize with empty state first
        this.initializeEmptyState();
        
        this.initialized = true;
        console.log('[NETWORK-PRIORITY] Initialization completed');
    }

    initializeEmptyState() {
        console.log('[NETWORK-PRIORITY] Initializing with empty state...');
        
        // Set empty data
        this.state.data.networkInterfaces = [];
        this.state.data.routingRules = [];
        this.state.data.statistics = { total: 0, online: 0, offline: 0 };
        
        // Update UI with empty state
        this.updateUI();
        
        console.log('[NETWORK-PRIORITY] Empty state initialized');
    }

    setupGlobalHandlers() {
        console.log('[NETWORK-PRIORITY] Setting up global handlers...');
        
        // Prevent ALL form submissions on the page
        document.addEventListener('submit', (e) => {
            console.log('[NETWORK-PRIORITY] Global form submission prevented:', e.target);
            e.stopImmediatePropagation();
            e.preventDefault();
            e.stopPropagation();
            return false;
        }, true);
        
        // Prevent any global click handlers from interfering when popup is open
        document.addEventListener('click', (e) => {
            if (this.popupOpen) {
                // Check if click is inside current popup
                const popup = document.getElementById(this.currentPopup);
                if (popup && !popup.contains(e.target)) {
                    // Click outside popup - don't let other handlers process it
                    e.stopImmediatePropagation();
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('[NETWORK-PRIORITY] Prevented outside click interference');
                    return false;
                }
            }
        }, true);
        
        // Prevent page refresh from UNHANDLED button clicks only
        document.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                // Check if this button has our specific handler
                const button = e.target.tagName === 'BUTTON' ? e.target : e.target.closest('button');
                
                // Allow buttons that are handled by our system OR have specific classes
                const isHandled = button.hasAttribute('data-handled') || 
                                 button.id.includes('rule-btn') ||
                                 button.classList.contains('add-rule-popup-close') ||
                                 button.classList.contains('add-rule-popup-cancel') ||
                                 button.classList.contains('add-rule-popup-save') ||
                                 button.id === 'add-rule-btn' ||
                                 button.id === 'export-rules-btn' ||
                                 button.id === 'reset-defaults-btn' ||
                                 button.id === 'preview-changes-btn' ||
                                 button.id === 'apply-changes-btn' ||
                                 button.id === 'cancel-btn';
                
                if (!isHandled) {
                    console.log('[NETWORK-PRIORITY] Preventing unhandled button click:', button);
                    e.stopImmediatePropagation();
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }
            }
        }, true);
        
        console.log('[NETWORK-PRIORITY] Global handlers setup completed');
    }

    setupEventHandlers() {
        console.log('[NETWORK-PRIORITY] Setting up event handlers...');
        
        try {
            // Use capture phase and aggressive event prevention
            // Add rule popup handlers
            const addRuleBtn = document.getElementById('add-rule-btn');
            if (addRuleBtn) {
                addRuleBtn.setAttribute('data-handled', 'true');
                console.log('[NETWORK-PRIORITY] Adding Add Rule button event listener');
                addRuleBtn.addEventListener('click', (e) => {
                    console.log('[NETWORK-PRIORITY] Add Rule button clicked!', e);
                    e.stopImmediatePropagation(); // Stop all other listeners
                    e.preventDefault();
                    e.stopPropagation();
                    this.showAddRulePopup();
                    return false; // Extra prevention
                }, true); // Use capture phase
            } else {
                console.error('[NETWORK-PRIORITY] Add Rule button not found!');
            }
            
            const addRuleClose = document.querySelector('.add-rule-popup-close');
            if (addRuleClose) {
                addRuleClose.setAttribute('data-handled', 'true');
                addRuleClose.addEventListener('click', (e) => {
                    e.stopImmediatePropagation();
                    e.preventDefault();
                    e.stopPropagation();
                    this.hideAddRulePopup();
                    return false;
                }, true);
            }
            const addRuleCancel = document.querySelector('.add-rule-popup-cancel');
            if (addRuleCancel) {
                addRuleCancel.setAttribute('data-handled', 'true');
                addRuleCancel.addEventListener('click', (e) => {
                    e.stopImmediatePropagation();
                    e.preventDefault();
                    e.stopPropagation();
                    this.hideAddRulePopup();
                    return false;
                }, true);
            }
            const addRuleSave = document.querySelector('.add-rule-popup-save');
            if (addRuleSave) {
                addRuleSave.setAttribute('data-handled', 'true');
                addRuleSave.addEventListener('click', (e) => {
                    e.stopImmediatePropagation();
                    e.preventDefault();
                    e.stopPropagation();
                    this.saveRoutingRule();
                    return false;
                }, true);
            }

            // Other button handlers
            const exportRulesBtn = document.getElementById('export-rules-btn');
            if (exportRulesBtn) {
                exportRulesBtn.setAttribute('data-handled', 'true');
                exportRulesBtn.addEventListener('click', (e) => {
                    e.stopImmediatePropagation();
                    e.preventDefault();
                    e.stopPropagation();
                    this.exportRoutingRules();
                    return false;
                }, true);
            }

            const resetDefaultsBtn = document.getElementById('reset-defaults-btn');
            if (resetDefaultsBtn) {
                resetDefaultsBtn.setAttribute('data-handled', 'true');
                resetDefaultsBtn.addEventListener('click', (e) => {
                    e.stopImmediatePropagation();
                    e.preventDefault();
                    e.stopPropagation();
                    this.resetToDefaults();
                    return false;
                }, true);
            }

            const previewChangesBtn = document.getElementById('preview-changes-btn');
            if (previewChangesBtn) {
                previewChangesBtn.setAttribute('data-handled', 'true');
                previewChangesBtn.addEventListener('click', (e) => {
                    e.stopImmediatePropagation();
                    e.preventDefault();
                    e.stopPropagation();
                    this.previewChanges();
                    return false;
                }, true);
            }

            const applyChangesBtn = document.getElementById('apply-changes-btn');
            if (applyChangesBtn) {
                applyChangesBtn.setAttribute('data-handled', 'true');
                applyChangesBtn.addEventListener('click', (e) => {
                    e.stopImmediatePropagation();
                    e.preventDefault();
                    e.stopPropagation();
                    this.applyChanges();
                    return false;
                }, true);
            }

            const cancelBtn = document.getElementById('cancel-btn');
            if (cancelBtn) {
                cancelBtn.setAttribute('data-handled', 'true');
                cancelBtn.addEventListener('click', (e) => {
                    e.stopImmediatePropagation();
                    e.preventDefault();
                    e.stopPropagation();
                    this.cancelChanges();
                    return false;
                }, true);
            }

            // Handle table action buttons dynamically
            document.addEventListener('click', (e) => {
                if (e.target.matches('.rule-up-btn') || e.target.closest('.rule-up-btn')) {
                    const btn = e.target.closest('.rule-up-btn') || e.target;
                    btn.setAttribute('data-handled', 'true');
                    e.stopImmediatePropagation();
                    e.preventDefault();
                    e.stopPropagation();
                    this.moveRuleUp(btn);
                    return false;
                }

                if (e.target.matches('.rule-down-btn') || e.target.closest('.rule-down-btn')) {
                    const btn = e.target.closest('.rule-down-btn') || e.target;
                    btn.setAttribute('data-handled', 'true');
                    e.stopImmediatePropagation();
                    e.preventDefault();
                    e.stopPropagation();
                    this.moveRuleDown(btn);
                    return false;
                }

                if (e.target.matches('.rule-delete-btn') || e.target.closest('.rule-delete-btn')) {
                    const btn = e.target.closest('.rule-delete-btn') || e.target;
                    btn.setAttribute('data-handled', 'true');
                    e.stopImmediatePropagation();
                    e.preventDefault();
                    e.stopPropagation();
                    this.deleteRule(btn);
                    return false;
                }
            }, true);

            // Close on backdrop click with capture phase
            document.querySelectorAll('.popup-overlay').forEach(popup => {
                popup.addEventListener('click', (e) => {
                    if (e.target === popup) {
                        e.stopImmediatePropagation();
                        e.preventDefault();
                        e.stopPropagation();
                        this.hideAllPopups();
                        return false;
                    }
                }, true);
            });

            // Close on escape key with capture phase
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    e.stopImmediatePropagation();
                    e.preventDefault();
                    this.hideAllPopups();
                    return false;
                }
            }, true);
            
            // Refresh button handler
            const refreshBtn = document.getElementById('refresh-priority-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.requestInitialData();
                }, true);
            }
            
            console.log('[NETWORK-PRIORITY] Event handlers setup completed');
        } catch (error) {
            console.error('[NETWORK-PRIORITY] Error setting up event handlers:', error);
        }
    }

    // Popup show/hide methods following VPN section pattern
    showAddRulePopup() {
        console.log('[NETWORK-PRIORITY] Showing Add Rule popup');
        const popup = document.getElementById('add-rule-popup');
        if (popup) {
            // Set state before showing
            this.popupOpen = true;
            this.currentPopup = 'add-rule-popup';
            
            console.log('[NETWORK-PRIORITY] Add Rule popup element found, current styles:', {
                display: popup.style.display,
                opacity: popup.style.opacity,
                visibility: popup.style.visibility
            });
            
            // Populate interface dropdown
            this.populateInterfaceDropdown();
            
            popup.style.display = 'flex';
            // Force reflow for animation
            popup.offsetHeight;
            popup.style.opacity = '1';
            popup.style.visibility = 'visible';

            const content = popup.querySelector('.popup-content');
            if (content) {
                content.style.transform = 'scale(1)';
            }

            // Prevent body scroll
            document.body.style.overflow = 'hidden';
            
            console.log('[NETWORK-PRIORITY] Add Rule popup shown successfully');
        } else {
            console.error('[NETWORK-PRIORITY] Add Rule popup element not found!');
        }
    }

    hideAddRulePopup() {
        console.log('[NETWORK-PRIORITY] Hiding Add Rule popup');
        const popup = document.getElementById('add-rule-popup');
        if (popup) {
            // Clear state immediately
            this.popupOpen = false;
            this.currentPopup = null;
            
            popup.style.opacity = '0';
            popup.style.visibility = 'hidden';

            const content = popup.querySelector('.popup-content');
            if (content) {
                content.style.transform = 'scale(0.9)';
            }

            setTimeout(() => {
                popup.style.display = 'none';
                document.body.style.overflow = '';
                console.log('[NETWORK-PRIORITY] Add Rule popup hidden and cleanup completed');
            }, 300);
        } else {
            console.error('[NETWORK-PRIORITY] Add Rule popup element not found for hiding!');
        }
    }

    hideAllPopups() {
        console.log('[NETWORK-PRIORITY] Hiding all popups');
        this.popupOpen = false;
        this.currentPopup = null;
        this.hideAddRulePopup();
    }

    // Form submission methods
    saveRoutingRule() {
        const form = document.getElementById('add-rule-form');
        if (form.checkValidity()) {
            const formData = new FormData(form);
            const ruleData = Object.fromEntries(formData);
            
            // Convert metric and priority to numbers
            ruleData.metric = parseInt(ruleData.metric, 10);
            ruleData.priority = parseInt(ruleData.priority, 10);
            
            console.log('[NETWORK-PRIORITY] Saving routing rule:', ruleData);
            this.showNotification('Routing rule created successfully', 'success');
            this.hideAddRulePopup();
            form.reset();
            
            // Add to state and update table
            this.state.data.routingRules.push({
                id: Date.now(),
                destination: ruleData.destination,
                gateway: ruleData.gateway,
                interface: ruleData.interface,
                metric: ruleData.metric,
                priority: ruleData.priority,
                status: 'Active'
            });
            this.updateRoutingRulesTable();
        } else {
            form.reportValidity();
        }
    }

    // Table update methods
    updateRoutingRulesTable() {
        const tbody = document.getElementById('routing-rules-tbody');
        
        tbody.innerHTML = '';
        
        this.state.data.routingRules.forEach(rule => {
            const row = document.createElement('tr');
            row.setAttribute('data-rule-id', rule.id);
            row.innerHTML = `
                <td class="px-4 py-3 whitespace-nowrap">
                    <input type="checkbox" class="rule-checkbox rounded border-neutral-300">
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-neutral-900">${rule.priority}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-neutral-900">${rule.destination}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-neutral-900">${rule.gateway}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-neutral-900">${rule.interface}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-neutral-900">${rule.metric}</td>
                <td class="px-4 py-3 whitespace-nowrap">
                    <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">${rule.status}</span>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-neutral-500">
                    <button class="rule-up-btn text-blue-600 hover:text-blue-900 mr-2">
                        <i class="fa-solid fa-arrow-up"></i>
                    </button>
                    <button class="rule-down-btn text-blue-600 hover:text-blue-900 mr-2">
                        <i class="fa-solid fa-arrow-down"></i>
                    </button>
                    <button class="rule-delete-btn text-red-600 hover:text-red-900">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    populateInterfaceDropdown() {
        const select = document.getElementById('rule-interface');
        if (select) {
            select.innerHTML = '<option value="">Select an interface...</option>';
            
            this.state.data.networkInterfaces.forEach(iface => {
                const option = document.createElement('option');
                option.value = iface.name;
                option.textContent = iface.name + (iface.status === 'online' ? ' (Online)' : ' (Offline)');
                select.appendChild(option);
            });
        }
    }

    // Table action methods
    moveRuleUp() {
        console.log('[NETWORK-PRIORITY] Moving rule up');
        this.showNotification('Rule moved up', 'info');
    }

    moveRuleDown() {
        console.log('[NETWORK-PRIORITY] Moving rule down');
        this.showNotification('Rule moved down', 'info');
    }

    deleteRule() {
        console.log('[NETWORK-PRIORITY] Deleting rule');
        this.showNotification('Rule deleted', 'success');
    }

    // Other methods
    exportRoutingRules() {
        console.log('[NETWORK-PRIORITY] Exporting routing rules...');
        this.showNotification('Routing rules exported successfully', 'success');
    }

    resetToDefaults() {
        console.log('[NETWORK-PRIORITY] Resetting to defaults...');
        this.showNotification('Reset to defaults completed', 'info');
    }

    previewChanges() {
        console.log('[NETWORK-PRIORITY] Previewing changes...');
        this.showNotification('Changes previewed', 'info');
    }

    applyChanges() {
        console.log('[NETWORK-PRIORITY] Applying changes...');
        this.showNotification('Changes applied successfully', 'success');
    }

    cancelChanges() {
        console.log('[NETWORK-PRIORITY] Canceling changes...');
        this.showNotification('Changes canceled', 'info');
    }

    // Notification system
    showNotification(message, type = 'info') {
        // Remove existing notifications
        const existingNotification = document.querySelector('.notification-toast');
        if (existingNotification) {
            existingNotification.remove();
        }

        const notification = document.createElement('div');
        notification.className = `notification-toast fixed top-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 ${
            type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' :
            type === 'error' ? 'bg-red-100 text-red-800 border border-red-200' :
            'bg-blue-100 text-blue-800 border border-blue-200'
        }`;
        
        notification.innerHTML = `
            <div class="flex items-center space-x-2">
                <i class="fa-solid ${
                    type === 'success' ? 'fa-check-circle' :
                    type === 'error' ? 'fa-exclamation-circle' :
                    'fa-info-circle'
                }"></i>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    updateUI() {
        // Update statistics with safe defaults
        const stats = this.state.data.statistics || { total: 0, online: 0, offline: 0 };
        const totalEl = document.querySelector('[data-stat="total"]');
        const onlineEl = document.querySelector('[data-stat="online"]');
        const offlineEl = document.querySelector('[data-stat="offline"]');
        
        if (totalEl) totalEl.textContent = stats.total;
        if (onlineEl) onlineEl.textContent = stats.online;
        if (offlineEl) offlineEl.textContent = stats.offline;
        
        // Update routing rules table
        this.updateRoutingRulesTable();
        
        console.log('[NETWORK-PRIORITY] UI updated successfully');
    }

    // Remove auto-refresh functionality completely
    loadInitialData() {
        // This method is disabled to prevent auto-refresh and data corruption
        console.log('[NETWORK-PRIORITY] loadInitialData called but disabled to prevent conflicts');
        return;
    }

    // Initialize WebSocket connection
    initialize() {
        console.log('[NETWORK-PRIORITY] Initializing WebSocket connection...');
        if (this.wsClient) {
            this.wsClient.connect();
        } else {
            console.error('[NETWORK-PRIORITY] WebSocket client not initialized');
            this.enableFallbackMode();
        }
    }

    // WebSocket integration methods
    setupWebSocketCallbacks() {
        // WebSocket connection events
        this.wsClient.onConnected = () => {
            console.log('[NETWORK-PRIORITY] WebSocket connected');
            this.updateConnectionStatus(true);
            this.requestInitialData();
        };

        this.wsClient.onDisconnected = () => {
            console.log('[NETWORK-PRIORITY] WebSocket disconnected');
            this.updateConnectionStatus(false);
        };

        this.wsClient.onError = (error) => {
            console.error('[NETWORK-PRIORITY] WebSocket error:', error);
            this.showNotification('Connection error: ' + error.message, 'error');
            this.enableFallbackMode();
        };

        // Network priority data events
        this.wsClient.onNetworkPriorityData = (data) => {
            console.log('[NETWORK-PRIORITY] Network priority data received:', data);
            this.updateNetworkPriorityData(data);
        };

        this.wsClient.onNetworkPriorityResponse = (response) => {
            console.log('[NETWORK-PRIORITY] Network priority response received:', response);
            this.handleNetworkPriorityResponse(response);
        };
    }

    requestInitialData() {
        console.log('[NETWORK-PRIORITY] Requesting initial network priority data');
        this.showLoadingState();
        this.wsClient.requestNetworkPriorityData();
    }

    updateNetworkPriorityData(data) {
        console.log('[NETWORK-PRIORITY] Updating network priority data:', data);
        
        // Update internal state with WebSocket data
        this.state.data.networkInterfaces = data.networkInterfaces || [];
        this.state.data.routingRules = data.routingRules || [];
        this.state.data.statistics = data.statistics || {
            total: 0,
            online: 0,
            offline: 0,
            activeRules: 0,
            lastUpdated: new Date().toLocaleString()
        };
        
        // Update UI components
        this.updateInterfacesList();
        this.updateRoutingRulesTable();
        this.updateStatisticsDisplay();
        
        this.hideLoadingState();
        
        // Show success notification
        this.showNotification('Network priority data updated successfully', 'success');
    }

    handleNetworkPriorityResponse(response) {
        console.log('[NETWORK-PRIORITY] Handling network priority response:', response);
        
        const { action, success, message } = response;
        
        if (success) {
            this.showNotification(message || 'Operation completed successfully', 'success');
            
            // Refresh data after successful operations
            if (['add_routing_rule', 'update_routing_rule', 'delete_routing_rule', 
                 'set_interface_priority', 'apply_configuration', 'reset_configuration'].includes(action)) {
                setTimeout(() => {
                    this.requestInitialData();
                }, 1000);
            }
        } else {
            this.showNotification(message || 'Operation failed', 'error');
        }
    }

    updateInterfacesList() {
        const container = document.getElementById('interfaces-container');
        if (!container) return;
        
        container.innerHTML = '';
        
        const interfaces = this.state.data.networkInterfaces || [];
        interfaces.forEach((iface, index) => {
            const interfaceEl = document.createElement('div');
            interfaceEl.className = 'flex items-center justify-between p-4 bg-white rounded-lg border border-neutral-200';
            interfaceEl.innerHTML = `
                <div class="flex items-center space-x-4">
                    <div class="w-4 h-4 rounded-full ${iface.status === 'online' ? 'bg-green-500' : 'bg-gray-400'}"></div>
                    <div>
                        <div class="font-medium text-neutral-900">${iface.name}</div>
                        <div class="text-sm text-neutral-500">${iface.ipAddress} â€¢ ${iface.type}</div>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-neutral-500">Priority: ${iface.priority}</span>
                    <button class="interface-up-btn text-blue-600 hover:text-blue-900 ${index === 0 ? 'opacity-50 cursor-not-allowed' : ''}">
                        <i class="fa-solid fa-arrow-up"></i>
                    </button>
                    <button class="interface-down-btn text-blue-600 hover:text-blue-900 ${index === interfaces.length - 1 ? 'opacity-50 cursor-not-allowed' : ''}">
                        <i class="fa-solid fa-arrow-down"></i>
                    </button>
                </div>
            `;
            
            // Add event listeners for interface priority changes
            const upBtn = interfaceEl.querySelector('.interface-up-btn');
            const downBtn = interfaceEl.querySelector('.interface-down-btn');
            
            if (upBtn && index > 0) {
                upBtn.addEventListener('click', () => {
                    this.moveInterfaceUp(index);
                });
            }
            
            if (downBtn && index < interfaces.length - 1) {
                downBtn.addEventListener('click', () => {
                    this.moveInterfaceDown(index);
                });
            }
            
            container.appendChild(interfaceEl);
        });
    }

    updateStatisticsDisplay() {
        const stats = this.state.data.statistics || {};
        const totalEl = document.querySelector('[data-stat="total"]');
        const onlineEl = document.querySelector('[data-stat="online"]');
        const offlineEl = document.querySelector('[data-stat="offline"]');
        
        if (totalEl) totalEl.textContent = stats.total || this.state.data.networkInterfaces.length;
        if (onlineEl) onlineEl.textContent = stats.online || this.state.data.networkInterfaces.filter(i => i.status === 'online').length;
        if (offlineEl) offlineEl.textContent = stats.offline || this.state.data.networkInterfaces.filter(i => i.status === 'offline').length;
    }

    moveInterfaceUp(index) {
        const interfaces = this.state.data.networkInterfaces;
        if (index <= 0 || !interfaces.length) return;
        
        // Swap interfaces in array
        [interfaces[index - 1], interfaces[index]] = [interfaces[index], interfaces[index - 1]];
        
        // Update priorities
        interfaces.forEach((iface, i) => {
            iface.priority = i + 1;
        });
        
        // Update UI
        this.updateInterfacesList();
        
        // Send to backend via WebSocket
        this.wsClient.setInterfacePriority(interfaces[index].name, interfaces[index].priority);
    }

    moveInterfaceDown(index) {
        const interfaces = this.state.data.networkInterfaces;
        if (index >= interfaces.length - 1 || !interfaces.length) return;
        
        // Swap interfaces in array
        [interfaces[index], interfaces[index + 1]] = [interfaces[index + 1], interfaces[index]];
        
        // Update priorities
        interfaces.forEach((iface, i) => {
            iface.priority = i + 1;
        });
        
        // Update UI
        this.updateInterfacesList();
        
        // Send to backend via WebSocket
        this.wsClient.setInterfacePriority(interfaces[index].name, interfaces[index].priority);
    }

    updateConnectionStatus(connected) {
        const statusDot = document.getElementById('priority-status-dot');
        const statusText = document.getElementById('priority-connection-text');
        const refreshBtn = document.getElementById('refresh-priority-btn');
        
        if (connected) {
            statusDot.classList.remove('bg-red-500');
            statusDot.classList.add('bg-green-500');
            statusText.textContent = 'Connected';
            
            if (refreshBtn) {
                refreshBtn.disabled = false;
                refreshBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                refreshBtn.title = 'Refresh network priority data';
            }
        } else {
            statusDot.classList.remove('bg-green-500');
            statusDot.classList.add('bg-red-500');
            statusText.textContent = 'Disconnected';
            
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.classList.add('opacity-50', 'cursor-not-allowed');
                refreshBtn.title = 'Reconnecting...';
            }
        }
    }

    showLoadingState() {
        // Show loading indicators in the UI
        const refreshIcon = document.getElementById('priority-refresh-icon');
        if (refreshIcon) {
            refreshIcon.classList.add('fa-spin');
        }
    }

    hideLoadingState() {
        // Hide loading indicators
        const refreshIcon = document.getElementById('priority-refresh-icon');
        if (refreshIcon) {
            refreshIcon.classList.remove('fa-spin');
        }
    }

    enableFallbackMode() {
        console.log('[NETWORK-PRIORITY] Enabling fallback mode with mock data');
        
        // Use mock data when WebSocket is not available
        const mockData = {
            networkInterfaces: [
                { id: '1', name: 'eth0', ipAddress: '192.168.1.100', status: 'online', type: 'wired', priority: 1, metric: 100 },
                { id: '2', name: 'wlan0', ipAddress: '192.168.1.101', status: 'online', type: 'wireless', priority: 2, metric: 200 },
                { id: '3', name: 'lo', ipAddress: '127.0.0.1', status: 'online', type: 'loopback', priority: 3, metric: 300 }
            ],
            routingRules: [
                { id: '1', destination: '0.0.0.0/0', gateway: '192.168.1.1', interface: 'eth0', metric: 100, priority: 1, status: 'Active' },
                { id: '2', destination: '192.168.1.0/24', gateway: '0.0.0.0', interface: 'eth0', metric: 100, priority: 1, status: 'Active' }
            ],
            statistics: {
                total: 3,
                online: 3,
                offline: 0,
                activeRules: 2,
                lastUpdated: new Date().toLocaleString()
            }
        };
        
        this.updateNetworkPriorityData(mockData);
    }
}

// Initialize the network priority section
function initializeNetworkPrioritySection() {
    console.log('[NETWORK-PRIORITY] Starting initialization...');
    if (!window.networkPrioritySection) {
        window.networkPrioritySection = new NetworkPrioritySection();
        
        // Initialize WebSocket connection
        window.networkPrioritySection.initialize();
        
        console.log('[NETWORK-PRIORITY] Network Priority Section initialized successfully');
    } else {
        console.log('[NETWORK-PRIORITY] Network Priority Section already initialized');
    }
}

// Handle both cases: DOM ready vs already loaded
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeNetworkPrioritySection);
} else {
    // DOM is already loaded, initialize immediately
    initializeNetworkPrioritySection();
}

// Add manual test function for debugging
window.testNetworkPriorityPopups = function() {
    console.log('[NETWORK-PRIORITY] Testing popup functionality manually...');
    
    if (window.networkPrioritySection) {
        console.log('[NETWORK-PRIORITY] Network Priority Section instance found');
        
        // Test add rule popup
        console.log('[NETWORK-PRIORITY] Testing Add Rule popup...');
        window.networkPrioritySection.showAddRulePopup();
        
        setTimeout(() => {
            window.networkPrioritySection.hideAddRulePopup();
            console.log('[NETWORK-PRIORITY] Popup testing completed');
        }, 3000);
        
    } else {
        console.error('[NETWORK-PRIORITY] Network Priority Section instance not found!');
    }
};
</script>
