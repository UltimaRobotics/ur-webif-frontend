
<div class="max-w-6xl mx-auto">
    <div class="flex items-center justify-between mb-8">
        <h1 class="text-2xl text-neutral-800">Welcome to Ultima Robotics</h1>
        <div class="flex items-center space-x-4">
            <button id="auto-refresh-toggle" class="text-sm text-neutral-500 hover:text-neutral-700 flex items-center space-x-1 px-3 py-1 rounded border border-neutral-300 hover:bg-neutral-50 transition-colors" title="Toggle automatic refresh">
                <i class="fa-solid fa-clock" id="auto-refresh-icon"></i>
                <span id="auto-refresh-text">Auto</span>
            </button>
            <button id="refresh-data-btn" class="text-sm text-neutral-500 hover:text-neutral-700 flex items-center space-x-1 px-3 py-1 rounded border border-neutral-300 hover:bg-neutral-50 transition-colors">
                <i class="fa-solid fa-refresh" id="refresh-icon"></i>
                <span>Refresh</span>
            </button>
            <span class="text-sm text-neutral-500" data-last-login></span>
            <div id="update-indicator" class="flex items-center space-x-1 text-xs text-neutral-400">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse" id="status-dot"></div>
                <span data-last-update></span>
            </div>
        </div>
    </div>

    <!-- System Stats Section -->
    <div class="system p-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="bg-gradient-to-br from-neutral-50 to-neutral-100 border border-neutral-200 rounded-lg p-4">
                <div class="cpu flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-2">
                        <i class="text-neutral-600 fa-solid fa-gauge-high"></i>
                        <span class="text-neutral-800">CPU Usage</span>
                    </div>
                    <span class="text-2xl text-neutral-600" data-cpu-usage>0%</span>
                </div>
                <div class="w-full bg-neutral-200 rounded-full h-3 mb-2">
                    <div class="bg-neutral-500 h-3 rounded-full" data-cpu-progress style="width: 0%"></div>
                </div>
                <div class="text-xs text-neutral-600 space-y-1">
                    <div class="flex justify-between">
                        <span data-cpu-cores>0 Cores</span>
                        <span data-cpu-temp>0°C</span>
                    </div>
                    <div class="flex justify-between">
                        <span data-cpu-base-clock>0 GHz</span>
                        <span data-cpu-boost-clock>0 GHz</span>
                    </div>
                </div>
            </div>

            <div class="bg-gradient-to-br from-neutral-50 to-neutral-100 border border-neutral-200 rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-2">
                        <i class="text-neutral-600 fa-solid fa-memory"></i>
                        <span class="text-neutral-800">RAM Usage</span>
                    </div>
                    <span class="text-2xl text-neutral-600" data-ram-usage>0%</span>
                </div>
                <div class="w-full bg-neutral-200 rounded-full h-3 mb-2">
                    <div class="bg-neutral-500 h-3 rounded-full" data-ram-progress style="width: 0%"></div>
                </div>
                <div class="text-xs text-neutral-600 space-y-1">
                    <div class="flex justify-between">
                        <span data-ram-used>0 GB</span>
                        <span data-ram-total>0 GB</span>
                    </div>
                    <div class="flex justify-between">
                        <span data-ram-available>0 GB</span>
                        <span data-ram-type>N/A</span>
                    </div>
                </div>
            </div>

            <div class="bg-gradient-to-br from-neutral-50 to-neutral-100 border border-neutral-200 rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-2">
                        <i class="text-neutral-600 fa-solid fa-hard-drive"></i>
                        <span class="text-neutral-800">Swap Usage</span>
                    </div>
                    <span class="text-2xl text-neutral-600" data-swap-usage>0%</span>
                </div>
                <div class="w-full bg-neutral-200 rounded-full h-3 mb-2">
                    <div class="bg-neutral-500 h-3 rounded-full" data-swap-progress style="width: 0%"></div>
                </div>
                <div class="text-xs text-neutral-600 space-y-1">
                    <div class="flex justify-between">
                        <span data-swap-used>0 MB</span>
                        <span data-swap-total>0 GB</span>
                    </div>
                    <div class="flex justify-between">
                        <span data-swap-available>0 GB</span>
                        <span data-swap-priority>Normal</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Network Status Section -->
    <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="bg-gradient-to-br from-neutral-50 to-neutral-100 border border-neutral-200 rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-2">
                        <i class="text-neutral-600 fa-solid fa-globe"></i>
                        <span class="text-neutral-800">Internet</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <div class="w-2 h-2 bg-neutral-500 rounded-full" data-internet-indicator></div>
                        <span class="text-sm text-neutral-600" data-internet-status>Unknown</span>
                    </div>
                </div>
                <div class="text-xs text-neutral-600 space-y-1">
                    <div class="flex justify-between">
                        <span>External IP:</span>
                        <span data-external-ip>N/A</span>
                    </div>
                    <div class="flex justify-between">
                        <span>DNS Primary:</span>
                        <span data-dns-primary>N/A</span>
                    </div>
                    <div class="flex justify-between">
                        <span>DNS Secondary:</span>
                        <span data-dns-secondary>N/A</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Latency:</span>
                        <span class="text-neutral-600" data-latency>0 ms</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Bandwidth:</span>
                        <span data-bandwidth>N/A</span>
                    </div>
                </div>
            </div>

            <div class="bg-gradient-to-br from-neutral-50 to-neutral-100 border border-neutral-200 rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-2">
                        <i class="text-neutral-600 fa-solid fa-server"></i>
                        <span class="text-neutral-800">Ultima Server</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <div class="w-2 h-2 bg-neutral-500 rounded-full" data-server-indicator></div>
                        <span class="text-sm text-neutral-600" data-server-status>Unknown</span>
                    </div>
                </div>
                <div class="text-xs text-neutral-600 space-y-1">
                    <div class="flex justify-between">
                        <span>Server:</span>
                        <span data-server-hostname>N/A</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Port:</span>
                        <span data-server-port>0</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Protocol:</span>
                        <span data-server-protocol>N/A</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Last Ping:</span>
                        <span class="text-neutral-600" data-last-ping>0 ms</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Session:</span>
                        <span data-session-duration>N/A</span>
                    </div>
                </div>
            </div>

            <div class="bg-gradient-to-br from-neutral-50 to-neutral-100 border border-neutral-200 rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-2">
                        <i class="text-neutral-600 fa-solid fa-ethernet"></i>
                        <span class="text-neutral-800">Connection Type</span>
                    </div>
                    <div class="text-sm text-neutral-600" data-connection-type>Unknown</div>
                </div>
                <div class="text-xs text-neutral-600 space-y-1">
                    <div class="flex justify-between">
                        <span>Interface:</span>
                        <span data-interface-name>N/A</span>
                    </div>
                    <div class="flex justify-between">
                        <span>MAC Address:</span>
                        <span data-mac-address>N/A</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Local IP:</span>
                        <span data-local-ip>N/A</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Gateway:</span>
                        <span data-gateway-ip>N/A</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Speed:</span>
                        <span data-connection-speed>N/A</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile/Cellular Status Section -->
    <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="bg-gradient-to-br from-neutral-50 to-neutral-100 border border-neutral-200 rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-2">
                        <i class="text-neutral-600 fa-solid fa-signal"></i>
                        <span class="text-neutral-800">Signal Strength</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="flex items-center space-x-1" data-signal-bars>
                            <div class="w-1 h-3 bg-neutral-300 rounded"></div>
                            <div class="w-1 h-4 bg-neutral-300 rounded"></div>
                            <div class="w-1 h-5 bg-neutral-300 rounded"></div>
                            <div class="w-1 h-6 bg-neutral-300 rounded"></div>
                        </div>
                        <span class="text-sm text-neutral-500" data-signal-status>No Signal</span>
                    </div>
                </div>
                <div class="text-xs text-neutral-600 space-y-1">
                    <div class="flex justify-between">
                        <span>RSSI:</span>
                        <span class="text-neutral-600" data-rssi>0 dBm</span>
                    </div>
                    <div class="flex justify-between">
                        <span>RSRP:</span>
                        <span class="text-neutral-600" data-rsrp>0 dBm</span>
                    </div>
                    <div class="flex justify-between">
                        <span>RSRQ:</span>
                        <span class="text-neutral-600" data-rsrq>0 dB</span>
                    </div>
                    <div class="flex justify-between">
                        <span>SINR:</span>
                        <span class="text-neutral-600" data-sinr>0 dB</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Cell ID:</span>
                        <span class="text-neutral-500" data-cell-id>N/A</span>
                    </div>
                </div>
            </div>

            <div class="bg-gradient-to-br from-neutral-50 to-neutral-100 border border-neutral-200 rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-2">
                        <i class="text-neutral-600 fa-solid fa-mobile-screen-button"></i>
                        <span class="text-neutral-800">Connection Status</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <div class="w-2 h-2 bg-neutral-400 rounded-full" data-cellular-indicator></div>
                        <span class="text-sm text-neutral-600" data-cellular-status>Disconnected</span>
                    </div>
                </div>
                <div class="text-xs text-neutral-600 space-y-1">
                    <div class="flex justify-between">
                        <span>Network:</span>
                        <span class="text-neutral-500" data-network-name>N/A</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Technology:</span>
                        <span class="text-neutral-500" data-technology>N/A</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Band:</span>
                        <span class="text-neutral-500" data-band>N/A</span>
                    </div>
                    <div class="flex justify-between">
                        <span>APN:</span>
                        <span class="text-neutral-500" data-apn>N/A</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Data Usage:</span>
                        <span class="text-neutral-500" data-data-usage>0 MB</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions Section -->
    <div id="quick-actions" class="mb-8">
        <h2 class="text-lg text-neutral-800 mb-4">Quick Actions</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <div id="cellular-cnfg-btn" class="action-card bg-white rounded-lg border border-neutral-200 p-5 hover:shadow-md transition-shadow cursor-pointer">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-10 h-10 rounded-full bg-neutral-100 flex items-center justify-center">
                        <i class="fa-solid fa-plus text-neutral-600"></i>
                    </div>
                    <i class="fa-solid fa-arrow-right text-neutral-400"></i>
                </div>
                <h3 class="text-sm text-neutral-800">Configure Cellular</h3>
                <p class="text-xs text-neutral-500 mt-1">Manage 5G/LTE configuration</p>
            </div>

            <div id="network-scan-btn" class="action-card bg-white rounded-lg border border-neutral-200 p-5 hover:shadow-md transition-shadow cursor-pointer">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-10 h-10 rounded-full bg-neutral-100 flex items-center justify-center">
                        <i class="fa-solid fa-wifi text-neutral-600"></i>
                    </div>
                    <i class="fa-solid fa-arrow-right text-neutral-400"></i>
                </div>
                <h3 class="text-sm text-neutral-800">Network Scan</h3>
                <p class="text-xs text-neutral-500 mt-1">Discover devices on your network</p>
            </div>

            <div id="update-firmware-btn" class="action-card bg-white rounded-lg border border-neutral-200 p-5 hover:shadow-md transition-shadow cursor-pointer">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-10 h-10 rounded-full bg-neutral-100 flex items-center justify-center">
                        <i class="fa-solid fa-download text-neutral-600"></i>
                    </div>
                    <i class="fa-solid fa-arrow-right text-neutral-400"></i>
                </div>
                <h3 class="text-sm text-neutral-800">Update Firmware</h3>
                <p class="text-xs text-neutral-500 mt-1">Keep your devices up to date</p>
            </div>

            <div id="backup-config-btn" class="action-card bg-white rounded-lg border border-neutral-200 p-5 hover:shadow-md transition-shadow cursor-pointer">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-10 h-10 rounded-full bg-neutral-100 flex items-center justify-center">
                        <i class="fa-solid fa-shield text-neutral-600"></i>
                    </div>
                    <i class="fa-solid fa-arrow-right text-neutral-400"></i>
                </div>
                <h3 class="text-sm text-neutral-800">Backup Config</h3>
                <p class="text-xs text-neutral-500 mt-1">Save your current configuration</p>
            </div>
        </div>
    </div>

    <!-- Quick Start and Tutorials Section -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div id="quick-start" class="bg-white rounded-lg border border-neutral-200 p-6">
            <div class="flex items-center mb-4">
                <i class="fa-solid fa-rocket text-neutral-700 text-xl mr-3"></i>
                <h2 class="text-xl text-neutral-800">Quick Start</h2>
            </div>
            <p class="text-neutral-600 mb-6">Get started with Ultima Robotics platform in just a few steps.</p>
            <div class="space-y-4">
                <div class="flex items-start">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-neutral-200 flex items-center justify-center">
                        <span class="text-neutral-700">1</span>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-sm text-neutral-800">Connect your first device</h3>
                        <p class="text-sm text-neutral-600">Configure your robot and connect it to the network.</p>
                    </div>
                </div>
                <div class="flex items-start">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-neutral-200 flex items-center justify-center">
                        <span class="text-neutral-700">2</span>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-sm text-neutral-800">Set up your workspace</h3>
                        <p class="text-sm text-neutral-600">Configure your dashboard and preferences.</p>
                    </div>
                </div>
                <div class="flex items-start">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-neutral-200 flex items-center justify-center">
                        <span class="text-neutral-700">3</span>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-sm text-neutral-800">Create your first automation</h3>
                        <p class="text-sm text-neutral-600">Set up routines and automated tasks for your robots.</p>
                    </div>
                </div>
            </div>
            <button id="setup-wizard-btn" class="mt-6 w-full bg-neutral-800 hover:bg-neutral-900 text-white py-2 px-4 rounded-md text-sm">
                Start Setup Wizard
            </button>
        </div>

        <div id="tutorials" class="bg-white rounded-lg border border-neutral-200 p-6">
            <div class="flex items-center mb-4">
                <i class="fa-solid fa-play-circle text-neutral-700 text-xl mr-3"></i>
                <h2 class="text-xl text-neutral-800">Watch Tutorials</h2>
            </div>
            <p class="text-neutral-600 mb-6">Learn how to use Ultima Robotics platform with our video guides.</p>
            <div class="space-y-4">
                <div class="border border-neutral-200 rounded-md overflow-hidden">
                    <div class="bg-neutral-700 h-32 flex items-center justify-center">
                        <i class="fa-solid fa-play text-white text-3xl"></i>
                    </div>
                    <div class="p-3">
                        <h3 class="text-sm text-neutral-800">Getting Started with Ultima Robotics</h3>
                        <p class="text-xs text-neutral-500">5:32 min</p>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <span id="view-tutorials-btn" class="text-sm text-neutral-600 hover:text-neutral-900 flex items-center cursor-pointer">
                        <i class="fa-solid fa-list mr-2"></i>
                        View all tutorials
                    </span>
                    <span id="documentation-btn" class="text-sm text-neutral-600 hover:text-neutral-900 flex items-center cursor-pointer">
                        <i class="fa-solid fa-book mr-2"></i>
                        Documentation
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Dashboard JavaScript -->
<script>
/**
 * Dashboard WebSocket Client
 * Connects to backend-datalink WebSocket server for real-time dashboard data
 */

class DashboardWebSocket {
    constructor() {
        this.ws = null;
        this.connected = false;
        this.reconnectAttempts = 0;
        this.maxReconnectAttempts = 10;
        this.reconnectDelay = 5000;
        
        // Dynamic host detection for WebSocket URL
        const currentHost = window.location.hostname;
        this.url = `ws://${currentHost}:9002`; // Backend-datalink WebSocket server
        
        // Event callbacks
        this.onConnected = null;
        this.onDisconnected = null;
        this.onDataReceived = null;
        this.onUpdateReceived = null;
        this.onError = null;
        
        // Data storage
        this.dashboardData = {
            system: {},
            ram: {},
            swap: {},
            network: {},
            ultima_server: {},
            signal: {}
        };
    }

    connect() {
        try {
            console.log('[DASHBOARD-WS] Connecting to:', this.url);
            this.ws = new WebSocket(this.url);
            
            this.ws.onopen = () => {
                console.log('[DASHBOARD-WS] Connected to backend-datalink server');
                this.connected = true;
                this.reconnectAttempts = 0;
                
                // Request initial dashboard data
                this.requestDashboardData();
                
                if (this.onConnected) {
                    this.onConnected();
                }
            };

            this.ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    console.log('[DASHBOARD-WS] Message received:', message.type);
                    console.log('[DASHBOARD-WS] Full message data:', JSON.stringify(message, null, 2));
                    this.handleMessage(message);
                } catch (error) {
                    console.error('[DASHBOARD-WS] Error parsing message:', error);
                    console.error('[DASHBOARD-WS] Raw message data:', event.data);
                }
            };

            this.ws.onclose = () => {
                console.log('[DASHBOARD-WS] Disconnected from backend-datalink server');
                this.connected = false;
                
                if (this.onDisconnected) {
                    this.onDisconnected();
                }
                
                this.scheduleReconnect();
            };

            this.ws.onerror = (error) => {
                console.error('[DASHBOARD-WS] WebSocket error:', error);
                this.connected = false;
                
                // Provide more detailed error information
                let errorMessage = 'WebSocket connection error';
                if (error instanceof Error) {
                    errorMessage += ': ' + error.message;
                } else {
                    errorMessage += ': Server may be unavailable on port 9002';
                }
                
                console.error('[DASHBOARD-WS] Connection details:', {
                    url: this.url,
                    readyState: this.ws ? this.ws.readyState : 'null',
                    timestamp: new Date().toISOString()
                });
                
                if (this.onError) {
                    this.onError(new Error(errorMessage));
                }
            };

        } catch (error) {
            console.error('[DASHBOARD-WS] Failed to connect:', error);
            this.scheduleReconnect();
        }
    }

    disconnect() {
        if (this.reconnectTimer) {
            clearTimeout(this.reconnectTimer);
        }
        
        if (this.ws) {
            this.ws.close();
            this.ws = null;
        }
        
        this.connected = false;
    }

    sendMessage(message) {
        if (this.connected && this.ws.readyState === WebSocket.OPEN) {
            this.ws.send(JSON.stringify(message));
            console.log('[DASHBOARD-WS] Message sent:', message.type);
        } else {
            console.warn('[DASHBOARD-WS] Cannot send message - not connected');
        }
    }

    requestDashboardData(categories = null) {
        const message = {
            type: 'get_dashboard_data'
        };
        
        if (categories && Array.isArray(categories)) {
            message.categories = categories;
        }
        
        this.sendMessage(message);
    }

    subscribeToUpdates() {
        this.sendMessage({
            type: 'subscribe_updates'
        });
    }

    handleMessage(message) {
        const { type, data, category, timestamp } = message;

        console.log('[DASHBOARD-WS] Processing message:', { type, category, hasData: !!data, timestamp });

        switch (type) {
            case 'welcome':
                console.log('[DASHBOARD-WS] Welcome message received:', message.message);
                break;

            case 'dashboard_data':
                console.log('[DASHBOARD-WS] Initial dashboard data received');
                console.log('[DASHBOARD-WS] Data structure:', JSON.stringify(data, null, 2));
                
                // Handle the nested backend data structure
                if (data) {
                    // If data is already in expected nested format (cpu, ram, etc.)
                    if (data.cpu || data.ram || data.swap || data.network || data.ultima_server || data.signal) {
                        console.log('[DASHBOARD-WS] Data is in nested backend format, applying mapping');
                        this.dashboardData = this.mapDataStructure(data);
                    } 
                    // If data is already in expected flat structure (system, ram, etc.)
                    else if (data.system || data.ram || data.swap || data.network || data.ultima_server || data.signal) {
                        console.log('[DASHBOARD-WS] Data is already in expected flat format');
                        this.dashboardData = { ...this.dashboardData, ...data };
                    }
                    // Otherwise try to map it using the mapping function
                    else {
                        console.log('[DASHBOARD-WS] Attempting to map unknown data structure');
                        this.dashboardData = this.mapDataStructure(data);
                    }
                } else {
                    console.warn('[DASHBOARD-WS] No data received in dashboard_data message');
                }
                
                console.log('[DASHBOARD-WS] Final dashboard data:', JSON.stringify(this.dashboardData, null, 2));
                
                if (this.onDataReceived) {
                    this.onDataReceived(this.dashboardData, timestamp);
                }
                break;

            case 'dashboard_update':
                console.log('[DASHBOARD-WS] Real-time update received for category:', category);
                console.log('[DASHBOARD-WS] Update data:', JSON.stringify(data, null, 2));
                
                if (category && data) {
                    // For updates, we need to handle the nested structure as well
                    if (category === 'cpu') {
                        // Map cpu update to system category
                        const mappedSystemData = this.mapDataStructure({ cpu: data });
                        this.dashboardData.system = mappedSystemData.system;
                        
                        if (this.onUpdateReceived) {
                            this.onUpdateReceived('system', mappedSystemData.system, timestamp);
                        }
                    } else if (category === 'network') {
                        // Handle nested network updates
                        const mappedNetworkData = this.mapDataStructure({ network: data });
                        this.dashboardData.network = mappedNetworkData.network;
                        
                        if (this.onUpdateReceived) {
                            this.onUpdateReceived('network', mappedNetworkData.network, timestamp);
                        }
                    } else if (category === 'signal') {
                        // Handle nested signal updates
                        const mappedSignalData = this.mapDataStructure({ signal: data });
                        this.dashboardData.signal = mappedSignalData.signal;
                        
                        if (this.onUpdateReceived) {
                            this.onUpdateReceived('signal', mappedSignalData.signal, timestamp);
                        }
                    } else {
                        // Direct update for other categories
                        this.dashboardData[category] = data;
                        
                        if (this.onUpdateReceived) {
                            this.onUpdateReceived(category, data, timestamp);
                        }
                    }
                } else {
                    console.warn('[DASHBOARD-WS] Invalid update message:', { category, hasData: !!data });
                }
                break;

            case 'subscription_confirmed':
                console.log('[DASHBOARD-WS] Subscription confirmed:', message.message);
                break;

            case 'error':
                console.error('[DASHBOARD-WS] Server error:', message.message);
                
                if (this.onError) {
                    this.onError(new Error(message.message));
                }
                break;

            default:
                console.log('[DASHBOARD-WS] Unknown message type:', type);
        }
    }

    scheduleReconnect() {
        if (this.reconnectAttempts < this.maxReconnectAttempts) {
            this.reconnectAttempts++;
            console.log(`[DASHBOARD-WS] Scheduling reconnect attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts}`);
            
            this.reconnectTimer = setTimeout(() => {
                this.connect();
            }, this.reconnectDelay);
        } else {
            console.error('[DASHBOARD-WS] Max reconnect attempts reached');
            
            if (this.onError) {
                this.onError(new Error('Failed to reconnect to WebSocket server'));
            }
        }
    }

    mapDataStructure(data) {
        console.log('[DASHBOARD-WS] Mapping data structure:', Object.keys(data));
        
        // Try to map nested backend data structure to expected flat structure
        const mappedData = {
            system: {},
            ram: {},
            swap: {},
            network: {},
            ultima_server: {},
            signal: {}
        };
        
        // Map CPU fields -> system
        if (data.cpu) {
            mappedData.system.usage_percent = data.cpu.usage_percent;
            mappedData.system.cores = data.cpu.cores;
            mappedData.system.temperature = data.cpu.temperature_celsius;
            mappedData.system.base_clock = data.cpu.frequency_ghz;
            mappedData.system.boost_clock = data.cpu.frequency_ghz; // Use same value for both if no separate boost clock
        }
        
        // Map RAM fields
        if (data.ram) {
            mappedData.ram.usage_percent = data.ram.usage_percent;
            mappedData.ram.used_gb = data.ram.used_gb;
            mappedData.ram.total_gb = data.ram.total_gb;
            mappedData.ram.available_gb = (data.ram.total_gb || 0) - (data.ram.used_gb || 0);
            mappedData.ram.type = 'DDR4'; // Default value
        }
        
        // Map Swap fields
        if (data.swap) {
            mappedData.swap.usage_percent = data.swap.usage_percent;
            mappedData.swap.used_mb = data.swap.used_mb;
            mappedData.swap.total_gb = data.swap.total_gb;
            mappedData.swap.available_gb = (data.swap.total_gb || 0) - (data.swap.used_mb || 0) / 1024;
            mappedData.swap.priority = data.swap.status || 'Normal';
        }
        
        // Map Network fields (extract from nested internet and connection)
        if (data.network) {
            // Internet sub-structure
            if (data.network.internet) {
                mappedData.network.status = data.network.internet.status;
                mappedData.network.external_ip = data.network.internet.external_ip;
                mappedData.network.dns_primary = data.network.internet.dns_primary;
                mappedData.network.dns_secondary = data.network.internet.dns_secondary;
                mappedData.network.latency_ms = data.network.internet.latency_ms;
                mappedData.network.bandwidth = data.network.internet.bandwidth;
            }
            
            // Connection sub-structure - map to connection type fields
            if (data.network.connection) {
                mappedData.network.connection_status = data.network.connection.status;
                mappedData.network.interface = data.network.connection.interface_name;
                mappedData.network.mac_address = data.network.connection.mac_address;
                mappedData.network.local_ip = data.network.connection.local_ip;
                mappedData.network.gateway = data.network.connection.gateway;
                mappedData.network.speed = data.network.connection.speed;
            }
        }
        
        // Map Ultima Server fields
        if (data.ultima_server) {
            mappedData.ultima_server.status = data.ultima_server.status;
            mappedData.ultima_server.hostname = data.ultima_server.server;
            mappedData.ultima_server.port = data.ultima_server.port;
            mappedData.ultima_server.protocol = data.ultima_server.protocol;
            mappedData.ultima_server.ping_ms = data.ultima_server.last_ping_ms;
            mappedData.ultima_server.session_duration = data.ultima_server.session;
        }
        
        // Map Signal fields (extract from nested strength and connection)
        if (data.signal) {
            // Signal strength sub-structure
            if (data.signal.strength) {
                mappedData.signal.rssi = data.signal.strength.rssi_dbm;
                mappedData.signal.rsrp = data.signal.strength.rsrp_dbm;
                mappedData.signal.rsrq = data.signal.strength.rsrq_db;
                mappedData.signal.sinr = data.signal.strength.sinr_db;
                mappedData.signal.cell_id = data.signal.strength.cell_id;
                mappedData.signal.status = data.signal.strength.status;
            }
            
            // Signal connection sub-structure
            if (data.signal.connection) {
                mappedData.signal.operator = data.signal.connection.network;
                mappedData.signal.technology = data.signal.connection.technology;
                mappedData.signal.band = data.signal.connection.band;
                mappedData.signal.apn = data.signal.connection.apn;
                mappedData.signal.data_usage_mb = data.signal.connection.data_usage_mb;
                mappedData.signal.connection_status = data.signal.connection.status;
            }
        }
        
        console.log('[DASHBOARD-WS] Mapped data structure:', JSON.stringify(mappedData, null, 2));
        return mappedData;
    }

    getDashboardData() {
        return this.dashboardData;
    }

    isConnected() {
        return this.connected;
    }
}


class DashboardManager {
    constructor() {
        this.wsClient = new DashboardWebSocket();
        this.autoRefreshEnabled = true;
        this.lastUpdate = null;
        
        this.setupWebSocketCallbacks();
        this.setupUIEventHandlers();
        this.updateConnectionStatus(false);
    }

    initialize() {
        console.log('[DASHBOARD] Initializing dashboard manager...');
        this.wsClient.connect();
    }

    setupWebSocketCallbacks() {
        // WebSocket connection events
        this.wsClient.onConnected = () => {
            console.log('[DASHBOARD] WebSocket connected');
            this.updateConnectionStatus(true);
            this.subscribeToUpdates();
        };

        this.wsClient.onDisconnected = () => {
            console.log('[DASHBOARD] WebSocket disconnected');
            this.updateConnectionStatus(false);
        };

        this.wsClient.onError = (error) => {
            console.error('[DASHBOARD] WebSocket error:', error);
            this.showNotification('Connection error: ' + error.message, 'error');
            this.enableFallbackMode();
        };

        // Data events
        this.wsClient.onDataReceived = (data, timestamp) => {
            console.log('[DASHBOARD] Initial data received');
            this.updateAllUI(data);
            this.lastUpdate = new Date(timestamp * 1000);
            this.updateLastUpdateTime();
        };

        this.wsClient.onUpdateReceived = (category, data, timestamp) => {
            console.log('[DASHBOARD] Real-time update for category:', category);
            this.updateCategoryUI(category, data);
            this.lastUpdate = new Date(timestamp * 1000);
            this.updateLastUpdateTime();
        };
    }

    setupUIEventHandlers() {
        // Refresh button
        const refreshBtn = document.getElementById('refresh-data-btn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => {
                this.requestFreshData();
            });
        }

        // Auto-refresh toggle
        const autoRefreshToggle = document.getElementById('auto-refresh-toggle');
        if (autoRefreshToggle) {
            autoRefreshToggle.addEventListener('click', () => {
                this.toggleAutoRefresh();
            });
        }
    }

    subscribeToUpdates() {
        this.wsClient.subscribeToUpdates();
    }

    requestFreshData() {
        console.log('[DASHBOARD] Requesting fresh data');
        this.wsClient.requestDashboardData();
        
        // Show loading state
        const refreshIcon = document.getElementById('refresh-icon');
        if (refreshIcon) {
            refreshIcon.classList.add('fa-spin');
            setTimeout(() => {
                refreshIcon.classList.remove('fa-spin');
            }, 1000);
        }
    }

    toggleAutoRefresh() {
        this.autoRefreshEnabled = !this.autoRefreshEnabled;
        
        const autoRefreshIcon = document.getElementById('auto-refresh-icon');
        const autoRefreshText = document.getElementById('auto-refresh-text');
        
        if (autoRefreshIcon && autoRefreshText) {
            if (this.autoRefreshEnabled) {
                autoRefreshIcon.classList.remove('fa-clock');
                autoRefreshIcon.classList.add('fa-pause');
                autoRefreshText.textContent = 'Auto';
            } else {
                autoRefreshIcon.classList.remove('fa-pause');
                autoRefreshIcon.classList.add('fa-clock');
                autoRefreshText.textContent = 'Manual';
            }
        }
    }

    updateAllUI(data) {
        this.updateSystemUI(data.system || {});
        this.updateRAMUI(data.ram || {});
        this.updateSwapUI(data.swap || {});
        this.updateNetworkUI(data.network || {});
        this.updateUltimaServerUI(data.ultima_server || {});
        this.updateSignalUI(data.signal || {});
    }

    updateCategoryUI(category, data) {
        switch (category) {
            case 'system':
                this.updateSystemUI(data);
                break;
            case 'ram':
                this.updateRAMUI(data);
                break;
            case 'swap':
                this.updateSwapUI(data);
                break;
            case 'network':
                this.updateNetworkUI(data);
                break;
            case 'ultima_server':
                this.updateUltimaServerUI(data);
                break;
            case 'signal':
                this.updateSignalUI(data);
                break;
        }
    }

    updateSystemUI(data) {
        console.log('[DASHBOARD] Updating system UI with data:', JSON.stringify(data, null, 2));
        
        this.updateMetric('cpu-usage', data.usage_percent, '%');
        this.updateProgressBar('cpu-progress', data.usage_percent);
        this.updateElement('cpu-cores', `${data.cores || 0} Cores`);
        this.updateElement('cpu-temp', `${data.temperature || 0}°C`);
        this.updateElement('cpu-base-clock', `${(data.base_clock || 0).toFixed(2)} GHz`);
        this.updateElement('cpu-boost-clock', `${(data.boost_clock || 0).toFixed(2)} GHz`);
    }

    updateRAMUI(data) {
        this.updateMetric('ram-usage', data.usage_percent, '%');
        this.updateProgressBar('ram-progress', data.usage_percent);
        this.updateElement('ram-used', `${(data.used_gb || 0).toFixed(2)} GB`);
        this.updateElement('ram-total', `${(data.total_gb || 0).toFixed(2)} GB`);
        this.updateElement('ram-available', `${(data.available_gb || 0).toFixed(2)} GB`);
        this.updateElement('ram-type', data.type || 'N/A');
    }

    updateSwapUI(data) {
        this.updateMetric('swap-usage', data.usage_percent, '%');
        this.updateProgressBar('swap-progress', data.usage_percent);
        this.updateElement('swap-used', `${(data.used_mb || 0).toFixed(0)} MB`);
        this.updateElement('swap-total', `${(data.total_gb || 0).toFixed(2)} GB`);
        this.updateElement('swap-available', `${(data.available_gb || 0).toFixed(2)} GB`);
        this.updateElement('swap-priority', data.priority || 'Normal');
    }

    updateNetworkUI(data) {
        console.log('[DASHBOARD] Updating network UI with data:', JSON.stringify(data, null, 2));
        
        // Internet status
        const internetConnected = data.status === 'connected';
        console.log('[DASHBOARD] Internet connected status:', internetConnected, 'from data.status:', data.status);
        this.updateConnectionIndicator('internet-indicator', 'internet-status', internetConnected);
        this.updateElement('external-ip', data.external_ip || 'N/A');
        this.updateElement('dns-primary', data.dns_primary || 'N/A');
        this.updateElement('dns-secondary', data.dns_secondary || 'N/A');
        this.updateElement('latency', `${data.latency_ms || 0} ms`);
        this.updateElement('bandwidth', data.bandwidth || 'N/A');
        
        // Connection type fields
        const connectionConnected = data.connection_status === 'connected';
        this.updateElement('connection-type', data.connection_status || 'Unknown');
        this.updateElement('interface-name', data.interface || 'N/A');
        this.updateElement('mac-address', data.mac_address || 'N/A');
        this.updateElement('local-ip', data.local_ip || 'N/A');
        this.updateElement('gateway-ip', data.gateway || 'N/A');
        this.updateElement('connection-speed', data.speed || 'N/A');
    }

    updateUltimaServerUI(data) {
        console.log('[DASHBOARD] Updating Ultima server UI with data:', JSON.stringify(data, null, 2));
        
        const serverConnected = data.status === 'connected';
        console.log('[DASHBOARD] Server connected status:', serverConnected, 'from data.status:', data.status);
        this.updateConnectionIndicator('server-indicator', 'server-status', serverConnected);
        this.updateElement('server-hostname', data.hostname || 'N/A');
        this.updateElement('server-port', data.port || 0);
        this.updateElement('server-protocol', data.protocol || 'N/A');
        this.updateElement('last-ping', `${data.ping_ms || 0} ms`);
        this.updateElement('session-duration', data.session_duration || 'N/A');
    }

    updateSignalUI(data) {
        // Signal strength visualization
        this.updateSignalBars(data.rssi || -100);
        this.updateElement('rssi', `${data.rssi || 0} dBm`);
        this.updateElement('rsrp', `${data.rsrp || 0} dBm`);
        this.updateElement('rsrq', `${data.rsrq || 0} dB`);
        this.updateElement('sinr', `${data.sinr || 0} dB`);
        this.updateElement('cell-id', data.cell_id || 'N/A');
        
        // Connection status - use connection_status for cellular connection
        const cellularConnected = data.connection_status === 'connected';
        this.updateConnectionIndicator('cellular-indicator', 'cellular-status', cellularConnected);
        this.updateElement('network-name', data.operator || 'N/A');
        this.updateElement('technology', data.technology || 'N/A');
        this.updateElement('band', data.band || 'N/A');
        this.updateElement('apn', data.apn || 'N/A');
        this.updateElement('data-usage', `${data.data_usage_mb || 0} MB`);
    }

    updateSignalBars(rssi) {
        const signalBars = document.querySelector('[data-signal-bars]');
        if (!signalBars) return;

        const bars = signalBars.querySelectorAll('div');
        const signalStrength = this.calculateSignalStrength(rssi);
        
        bars.forEach((bar, index) => {
            if (index < signalStrength) {
                bar.classList.remove('bg-neutral-300');
                bar.classList.add('bg-green-500');
            } else {
                bar.classList.remove('bg-green-500');
                bar.classList.add('bg-neutral-300');
            }
        });

        // Update signal status text
        const signalStatus = document.querySelector('[data-signal-status]');
        if (signalStatus) {
            const statusText = this.getSignalStatusText(rssi);
            signalStatus.textContent = statusText;
        }
    }

    calculateSignalStrength(rssi) {
        if (rssi > -50) return 4;      // Excellent
        if (rssi > -60) return 3;      // Good
        if (rssi > -70) return 2;      // Fair
        if (rssi > -80) return 1;      // Poor
        return 0;                      // No signal
    }

    getSignalStatusText(rssi) {
        if (rssi > -50) return 'Excellent';
        if (rssi > -60) return 'Good';
        if (rssi > -70) return 'Fair';
        if (rssi > -80) return 'Poor';
        return 'No Signal';
    }

    updateConnectionStatus(connected) {
        const statusDot = document.getElementById('status-dot');
        const refreshBtn = document.getElementById('refresh-data-btn');
        
        if (statusDot) {
            if (connected) {
                statusDot.className = 'w-2 h-2 bg-green-500 rounded-full animate-pulse';
            } else {
                statusDot.className = 'w-2 h-2 bg-red-500 rounded-full';
            }
        }
        
        if (refreshBtn) {
            if (connected) {
                refreshBtn.disabled = false;
                refreshBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                refreshBtn.disabled = true;
                refreshBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }
    }

    updateLastUpdateTime() {
        const lastUpdateElement = document.querySelector('[data-last-update]');
        if (lastUpdateElement && this.lastUpdate) {
            const now = new Date();
            const diff = Math.floor((now - this.lastUpdate) / 1000);
            
            if (diff < 60) {
                lastUpdateElement.textContent = `Updated ${diff}s ago`;
            } else if (diff < 3600) {
                lastUpdateElement.textContent = `Updated ${Math.floor(diff / 60)}m ago`;
            } else {
                lastUpdateElement.textContent = `Updated ${Math.floor(diff / 3600)}h ago`;
            }
        }
    }

    // Helper functions
    updateMetric(elementId, value, suffix = '') {
        const element = document.querySelector(`[data-${elementId}]`);
        if (element && value !== undefined) {
            element.textContent = `${Math.round(value)}${suffix}`;
        }
    }

    updateProgressBar(elementId, value) {
        const element = document.querySelector(`[data-${elementId}]`);
        if (element && value !== undefined) {
            element.style.width = `${Math.min(100, Math.max(0, value))}%`;
            
            // Update color based on value
            element.className = 'h-3 rounded-full transition-all duration-300';
            if (value > 80) {
                element.classList.add('bg-red-500');
            } else if (value > 60) {
                element.classList.add('bg-yellow-500');
            } else {
                element.classList.add('bg-green-500');
            }
        }
    }

    updateElement(elementId, value) {
        const element = document.querySelector(`[data-${elementId}]`);
        if (element && value !== undefined) {
            element.textContent = value;
        }
    }

    updateConnectionIndicator(indicatorId, statusId, connected) {
        const indicator = document.querySelector(`[data-${indicatorId}]`);
        const status = document.querySelector(`[data-${statusId}]`);
        
        if (indicator) {
            if (connected) {
                indicator.classList.remove('bg-neutral-500', 'bg-red-500');
                indicator.classList.add('bg-green-500');
            } else {
                indicator.classList.remove('bg-green-500');
                indicator.classList.add('bg-red-500');
            }
        }
        
        if (status) {
            status.textContent = connected ? 'Connected' : 'Disconnected';
        }
    }

    showNotification(message, level = 'info') {
        console.log(`[DASHBOARD] ${level}: ${message}`);
        
        // Create toast notification for better user feedback
        this.createToastNotification(message, level);
    }

    createToastNotification(message, level = 'info') {
        // Remove existing toast if any
        const existingToast = document.getElementById('dashboard-toast');
        if (existingToast) {
            existingToast.remove();
        }

        // Create toast element
        const toast = document.createElement('div');
        toast.id = 'dashboard-toast';
        toast.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full`;
        
        // Style based on level
        const styles = {
            info: 'bg-blue-500 text-white',
            error: 'bg-red-500 text-white',
            warning: 'bg-yellow-500 text-black',
            success: 'bg-green-500 text-white'
        };
        
        toast.className += ' ' + (styles[level] || styles.info);
        toast.innerHTML = `
            <div class="flex items-center space-x-2">
                <i class="fa-solid fa-${level === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.parentElement.remove()" class="ml-4 hover:opacity-75">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
        `;
        
        // Add to page
        document.body.appendChild(toast);
        
        // Animate in
        setTimeout(() => {
            toast.classList.remove('translate-x-full');
            toast.classList.add('translate-x-0');
        }, 100);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 5000);
    }

    enableFallbackMode() {
        console.log('[DASHBOARD] Enabling fallback mode due to connection issues');
        
        // Show fallback status in UI
        this.updateConnectionStatus(false);
        this.showNotification('WebSocket server unavailable. Running in offline mode.', 'warning');
        
        // Load mock data or cached data if available
        this.loadFallbackData();
        
        // Disable real-time features
        this.disableRealTimeFeatures();
    }

    loadFallbackData() {
        console.log('[DASHBOARD] Loading fallback data');
        
        // Mock data for demonstration when WebSocket is unavailable
        const fallbackData = {
            system: {
                usage_percent: 45,
                cores: 8,
                temperature: 65,
                base_clock: 2.4,
                boost_clock: 4.2
            },
            ram: {
                usage_percent: 60,
                used_gb: 8.2,
                total_gb: 16.0,
                available_gb: 7.8,
                type: 'DDR4'
            },
            swap: {
                usage_percent: 15,
                used_mb: 512,
                total_gb: 8.0,
                available_gb: 7.5,
                priority: 'Normal'
            },
            network: {
                status: 'disconnected',
                external_ip: 'N/A',
                dns_primary: '8.8.8.8',
                dns_secondary: '8.8.4.4',
                latency_ms: 0,
                bandwidth: 'N/A'
            },
            ultima_server: {
                status: 'disconnected',
                hostname: 'N/A',
                port: 0,
                protocol: 'N/A',
                ping_ms: 0,
                session_duration: 'N/A'
            },
            signal: {
                rssi: -85,
                rsrp: -110,
                rsrq: -12,
                sinr: -5,
                cell_id: 'N/A',
                status: 'disconnected',
                operator: 'N/A',
                technology: 'N/A',
                band: 'N/A',
                apn: 'N/A',
                data_usage_mb: 0
            }
        };
        
        // Update UI with fallback data
        this.updateAllUI(fallbackData);
        
        // Update last update time to show this is fallback data
        this.lastUpdate = new Date();
        this.updateLastUpdateTime();
        
        // Add visual indicator that this is fallback data
        const statusDot = document.getElementById('status-dot');
        if (statusDot) {
            statusDot.className = 'w-2 h-2 bg-yellow-500 rounded-full animate-pulse';
        }
    }

    disableRealTimeFeatures() {
        console.log('[DASHBOARD] Disabling real-time features');
        
        // Disable refresh button
        const refreshBtn = document.getElementById('refresh-data-btn');
        if (refreshBtn) {
            refreshBtn.disabled = true;
            refreshBtn.classList.add('opacity-50', 'cursor-not-allowed');
            refreshBtn.title = 'Unavailable - WebSocket server not connected';
        }
        
        // Disable auto-refresh toggle
        const autoRefreshToggle = document.getElementById('auto-refresh-toggle');
        if (autoRefreshToggle) {
            autoRefreshToggle.disabled = true;
            autoRefreshToggle.classList.add('opacity-50', 'cursor-not-allowed');
            autoRefreshToggle.title = 'Unavailable - WebSocket server not connected';
        }
    }

    destroy() {
        console.log('[DASHBOARD] Destroying dashboard manager');
        this.wsClient.disconnect();
    }
}

// Initialize dashboard when DOM is ready
console.log('[DASHBOARD] Script loaded, waiting for DOM readiness');

function initializeDashboard() {
    console.log('[DASHBOARD] DOM ready, initializing dashboard');
    console.log('[DASHBOARD] Initialization context:', {
        timestamp: new Date().toISOString(),
        userAgent: navigator.userAgent,
        url: window.location.href,
        readyState: document.readyState
    });
    
    try {
        // Check if required DOM elements exist
        const requiredElements = [
            'refresh-data-btn',
            'auto-refresh-toggle',
            'status-dot'
        ];
        
        const missingElements = requiredElements.filter(id => !document.getElementById(id));
        if (missingElements.length > 0) {
            console.warn('[DASHBOARD] Missing DOM elements:', missingElements);
            console.log('[DASHBOARD] Available elements:', Array.from(document.querySelectorAll('[id]')).map(el => el.id).slice(0, 10));
        } else {
            console.log('[DASHBOARD] All required DOM elements found');
        }
        
        console.log('[DASHBOARD] Creating DashboardManager instance');
        const dashboard = new DashboardManager();
        
        console.log('[DASHBOARD] Starting WebSocket connection');
        dashboard.initialize();
        
        // Make dashboard available globally for debugging
        window.dashboardManager = dashboard;
        
        console.log('[DASHBOARD] Dashboard initialized successfully');
        console.log('[DASHBOARD] Dashboard manager available as window.dashboardManager');
    } catch (error) {
        console.error('[DASHBOARD] Failed to initialize dashboard:', error);
        console.error('[DASHBOARD] Error stack:', error.stack);
        
        // Show user-friendly error message
        const errorDiv = document.createElement('div');
        errorDiv.className = 'fixed top-4 left-4 bg-red-500 text-white p-4 rounded-lg shadow-lg z-50 max-w-md';
        errorDiv.innerHTML = `
            <div class="flex items-start space-x-2">
                <i class="fa-solid fa-exclamation-triangle mt-1"></i>
                <div>
                    <h4 class="font-bold">Dashboard Initialization Failed</h4>
                    <p class="text-sm mt-1">Unable to initialize the dashboard. Please refresh the page or contact support.</p>
                    <p class="text-xs mt-2 opacity-75">Error: ${error.message}</p>
                </div>
                <button onclick="this.parentElement.parentElement.remove()" class="ml-2 hover:opacity-75">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
        `;
        document.body.appendChild(errorDiv);
    }
}

// Handle different DOM ready scenarios
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeDashboard);
} else {
    // DOM is already ready
    initializeDashboard();
}
</script>
